---
title: "Math 530 Final Project"
subtitle: "P4: Replication/Extension Report" 
output: html_document
author: "Jeevan Bihari, Eric Stevens, Alexandra Salem"
---

#EDA

###Loading libraries
```{r warning=FALSE,message=FALSE}
library(tidyverse)
library(skimr)
library(readxl) # to read in the xlsx file
library(naniar) #for replacing 6 with NA
# install packages needed for ANCOVA analysis as per the "Discovering Statistics Using R" book by Field, Miles and Field
#install.packages("car"); install.packages("akima"); install.packages("compute.es"); install.packages ("effects");install.packages("ggplot2");install.packages("multcomp");install.packages("pastecs"); install.packages("WRS", repos="http://R-Forge.R-project.org")
# load ANCOVA relate libraries after installing them
library(car); # for Levene’s test, Type III sums of squares
library(compute.es); # for effect sizes
library(effects); # for adjusted means
library(ggplot2); # for graphs
library(multcomp); # for post hoc tests
library(pastecs); # for descriptive statistics
library(WRS) # for robust tests
library(phia)
```

```{r}
project_data <- read_excel("raw_data.xlsx", sheet = 1)
```

### Tidying data and creating composite measures for moods
```{r}
project_data_tidied <- project_data %>% 
  dplyr::select(-X__1, -X__2) %>% 
  replace_with_na_at(.vars = c("CARE1", "CARE2", "CARE3", "CARE4", "CARE5", "CARE6", "CARE7", "CARE8", "CARE9", "CARE10"),
                     condition = ~.x == 6)
```

```{r}
# convert binary data to 2-level factors
project_data_tidied$factored_sex<-factor(project_data_tidied$sex, levels = c(0,1), labels = c("Male", "Female"))
project_data_tidied$factored_condemp<-factor(project_data_tidied$condemp, levels = c(0,1), labels = c("Non-Empathetic", "Empathetic"))
project_data_tidied$factored_condcoat<-factor(project_data_tidied$condcoat, levels = c(0,1), labels = c("No Coat", "Coat"))


# creating composite metrics based on row-wise means using one of the technique shown here: https://stackoverflow.com/questions/9490485/how-can-i-get-the-average-mean-of-selected-columns
# Composite measure (mean) of the positive mood subscale
project_data_tidied$positive_mood <- rowMeans(subset(project_data_tidied, select = c(PANASPOS1, PANASPOS2, PANASPOS3, PANASPOS4, PANASPOS5, PANASPOS6, PANASPOS7, PANASPOS8, PANASPOS9, PANASPOS10)), na.rm = TRUE)
# Composite measure (mean) of the negative mood subscale
project_data_tidied$negative_mood <- rowMeans(subset(project_data_tidied, select = c(PANASNEG1, PANASNEG2, PANASNEG3, PANASNEG4, PANASNEG5, PANASNEG6, PANASNEG7, PANASNEG8, PANASNEG9, PANASNEG10)), na.rm = TRUE)
# Composite measure (mean) of the physician competence values per patient
project_data_tidied$competence <- rowMeans(subset(project_data_tidied, select = c(COMP1, COMP2, COMP3, COMP4, COMP5)), na.rm = TRUE)
# Composite measure (mean) of the physician warmth values per patient
project_data_tidied$warmth <- rowMeans(subset(project_data_tidied, select = c(WARM1, WARM2, WARM3, WARM4)), na.rm = TRUE)
# Composite measure (mean) of the empathy values per subject
project_data_tidied$empathy <- rowMeans(subset(project_data_tidied, select = c(CARE1, CARE2, CARE3, CARE4, CARE5, CARE6, CARE7, CARE8, CARE9, CARE10)), na.rm = TRUE)


project_data_tidied <- project_data_tidied[!is.na(project_data_tidied$factored_sex), ]
```

### Exploring study numbers
The first run had N=194 participants, all wore white coats, empathetic and not empathetic. This corresponds to study 1. The second run had N=1177 participants, mix of coat/no coat, empathetic/not empathetic in each study. This corresponds to studies 2-4.
```{r}
project_data %>% 
  dplyr::select(subid, condcoat, condemp, study) %>% 
  count(study)
```

### Exploring missing columns
```{r}
project_data %>% 
  filter(X__1 == 0 | X__1 == 1| X__2 == 0| X__2 ==1) 
```
All 161 observations with a 0 or 1 (so, not NA) in X__1 or X__2 are from study 1. That's out of 194 total observations in study 1.


### A discussion of issues uncovered in your data quality review. How did you resolve them? Or were you not able to? Could they impact your ability to replicate any downstream analyses?**

We had a few small issues that came up in our data review:

1. We had two columns attached to our data that were not labeled, and mostly had `NA` values. These were labeled as "X__1" and "X__2" by R. We wanted to determine if they were used in the paper somewhere. We went through the means and Ns in the paper, to determine if the N or mean of the unlabeled columns matched something in the paper. We did not find the Ns or means of those two columns anywhere in the paper. And, we were able to recreate the results in the paper without using those two unlabeled columns. Thus, we concluded that we should just remove those columns.

2. For some variables, it was a little unclear exactly which question in the questionaires they were attached to. Specifically for the WARM questions: `WARM1|WARM2|WARM4|WARM3`. There was not any direct reference from data description to numbered column names and therefore we depended on the assumption that column numbering corresponds to the order in which questions are laid out in the questionnaire.  Therefore, in the situation mentioned above we put the question that comes fourth in the warmth section in `WARM4` and the question that comes third in `WARM3` even though these columns are out of order in the dataset. Additionally, we found that this does not matter in the end as well, since we end up taking a composite of these scores, and do not look at individual scores within categories.

3. We had to replace certain values with `NA`. The categories `WARM#` and `COMP#` have options 0-4 and a 'does not apply' option in the questionnaire. However, in the raw data only numbers 1-5 appear and there are many blank spots. This led us to believe that it is likely that the the values 0-4 in the questionnaire map to values 1-5 in the raw data and the 'does not apply' option is mapped to an empty cell in the raw data. In comparison, the `CARE` columns used 1-6, where 6 was "does not apply". Thus, we changed the 6 in those columns to `NA` to match the `WARM` and `COMP` categories.

# Replication
In this section, we replicate the main analyses of the paper. This is split into three main sections: Empathy, Warmth, and Competence. In each section, we replicate the results from specific quotes from the paper, which are written in bold. At the end, we include a summary of these three sections with a replication of the paper's main figure. 

#### Empathy
**"Adjusting for mood, we found a significant main effect of nonverbal behavior on ratings of empathy such that participants rated physicians displaying empathic nonverbal behavior as more empathic (M = 3.29, SD = 1.15) than physicians displaying unempathic nonverbal behavior (M = 1.86, SD = .93, F(1,1362) = 568.49, p < .001, η2_p = .30; see Fig 3)."**


```{r}
lin_model_empathy_condemp <- lm(empathy ~ factored_condemp + positive_mood, data = project_data_tidied)

test <- Anova(lin_model_empathy_condemp, type = 2, adjustment = "bonferroni")
test
```

Here, we get $p < .001$ (indicated by the triple star), so that value is verified. This indicates a significant main effect of nonverbal behavior on ratings of empathy. Our f-statistic is off from theirs--we get 644.55 instead of 568.49.

```{r}
interactionMeans(lin_model_empathy_condemp, adjustment = "bonferroni")
```

We are getting close to their mean for each of these groups. We got 1.89 for the non-empathetic group, in comparison to 1.86, and 3.25 for the empathetic group, in comparison to 3.29. 

---

**"There was also a significant, albeit very small, main effect of subject gender such that male participants rated physicians in both conditions as more empathic (M = 2.70, SD = 1.21) than the female participants (M = 2.49, SD = 1.30, F(1,1362) = 6.60, p = .01, η2_p = .005)."**

```{r}
lin_model_empathy_gender <- lm(empathy ~ factored_sex, data = project_data_tidied)
test_empathy_gender <- Anova(lin_model_empathy_gender, type = 2, adjustment = "bonferroni")
test_empathy_gender
```

Here, we get $p = .002$, which is "double-star", significant, $p<.01$. This matches the paper, and indicates a small main effect of participant gender on ratings of empathy. Our f-statistic is again off from theirs, at 9.5719 instead of 6.60.

```{r}
interactionMeans(lin_model_empathy_gender, adjustment = "bonferroni")
```

Here, we are at the exact adjusted means from the paper for male and female. 

---

**"There was a marginally significant interaction of nonverbal behavior with participant gender (F(1,1362) = 3.00, p = .084, η2 p = .002) such that in the unempathic condition, women perceived physicians as less empathic (M = 1.73, SD = .88) than men (M = 2.05, SD = .98, F(679) = 13.48, p < .001, η2_p = .02)."**

```{r}
lin_model_condemp_gender_interaction <- lm(empathy ~ factored_condemp*factored_sex, data = project_data_tidied)
test_condemp_gender_interaction <- Anova(lin_model_condemp_gender_interaction, type = 2, adjustment = "bonferroni")
test_condemp_gender_interaction
```
Our p-value for the interaction is $p = 0.04$, which is actually lower than theirs. This indicates a significant interaction between nonverbal empathy and participant gender. Our p-value for sex is $p=.0004$, which is within their stated range, $p<.001$.

```{r}
phia::interactionMeans(lin_model_condemp_gender_interaction, adjustment = "bonferroni")
```

We get means close to those reported by the paper for un-empathetic conditions--1.77 for females and 1.98 for males.

---

#### Warmth

**"Adjusting for mood, we found a significant main effect of nonverbal behavior on ratings of warmth such that participants rated physicians displaying empathic nonverbal behavior as more warm (M = 3.73, SD = .93) than physicians displaying unempathic nonverbal behavior (M = 2.28, SD = .98, F(1,1362) = 674.49, p < .001, η2_p = .33)."**

```{r}
lin_model_warmth_condemp <- lm(warmth ~ factored_condemp + positive_mood, data = project_data_tidied)
Anova(lin_model_warmth_condemp, type = 2, adjustment = "bonferroni")
```
We are getting a lower p-value within their stated range, $p<.001$, indicating a significant main effect of nonverbal behavior on ratings of warmth. 

```{r}
interactionMeans(lin_model_warmth_condemp, adjustment = "bonferroni")
```

Additionally, we are able to get very close to their means. We get a mean of 2.31 for the non-empathetic group, in comparison to the paper's reported mean of 2.28. And, we get a mean of 3.70 for the empathetic group, in comparison to the paper's reported mean of 3.73.

**"We also found a significant interaction of nonverbal behavior with participant gender (F(1,1362) = 4.88, p = .027, η2 p = .004) such that in the unempathic condition, women perceived physicians as less warm (M = 2.20, SD = 0.98) than men (M = 2.42, SD = .95, F(1,679) = 4.46, p = .035, η2 p = .007)."**

```{r}
lin_model_warmth_condemp_gender_interaction <- lm(warmth ~ factored_sex*factored_condemp, data = project_data_tidied)
Anova(lin_model_warmth_condemp_gender_interaction, type = 2)
```
For the interaction, we are getting a p-value of $p = .009$ which is higher than theirs, $p = .004$. We also have a slightly higher F-statistic for the interaction.

```{r}
interactionMeans(lin_model_warmth_condemp_gender_interaction)
```
We are able to get their exact means. For the non-empathetic condition, we get an adjusted mean of 2.42 for males and 2.20 for females, which matches the paper exactly.

---

#### Competence

**"Adjusting for mood, there was a significant main effect of nonverbal behavior on ratings of competence, such that participants rated physicians displaying empathic nonverbal behavior as more competent (M = 3.64, SD = .65) than physicians displaying unempathic nonverbal behavior (M = 3.21, SD = .81, F(1,1362) = 85.11, p < .001, η2_p = .06)."**

```{r}
lin_model_competence_condemp <- lm(competence ~ factored_condemp + positive_mood, data = project_data_tidied)
Anova(lin_model_competence_condemp, type = 2, adjustment = "bonferroni")
```
Again, we get a p-value within their range, $p<.001$, indicating the significant main effect of nonverbal behvior on ratings of competence.

```{r}
interactionMeans(lin_model_competence_condemp, adjustment = "bonferroni")
```
And, we are able to get very close to their means. For the non-empathetic group, we get a mean of 3.23 in comparison to the paper's reported mean of 3.21. For the empathetic group, we get a mean of 3.62 in comparison to the paper's reported mean of 3.64.


####Summary of the main effect of nonverbal empathy

Here, we replicate the main figure from the paper, that summarizes the main effect of nonverbal empathy on ratings of empathy, warmth, and competence.

```{r}

emp_mean <- as.data.frame(interactionMeans(lin_model_empathy_condemp, adjustment = "bonferroni"))[1,2]
emp_error <- as.data.frame(interactionMeans(lin_model_empathy_condemp, adjustment = "bonferroni"))[2,2] 
emp_mean
emp_error

warmth_mean<- as.data.frame(interactionMeans(lin_model_warmth_condemp, adjustment = "bonferroni"))[1,2]
warmth_error<- as.data.frame(interactionMeans(lin_model_warmth_condemp, adjustment = "bonferroni"))[2,2]
warmth_mean
warmth_error

competence_mean<-as.data.frame(interactionMeans(lin_model_competence_condemp, adjustment = "bonferroni"))[1,2]
competence_error<-as.data.frame(interactionMeans(lin_model_competence_condemp, adjustment = "bonferroni"))[2,2]
competence_mean
competence_error

#all adjusted for mean.
#error bars * 1.96, -1.96 for confidence intervals
```

**Add Eric's figure here**

# Extension

In order to use ANCOVA, covariates need to be independent of the treatment effect(s). To accomplish that, one should run an ANOVA with the covariate as the outcome and the independent variable(s) as predictors to check that the covariate does not differ significantly across levels of these variables. No ANCOVA should be performed using those covariates if there is a significant result.

The experiment in our paper performed an ANCOVA with positive and negative moods as covariates. But these covariates were not independent of the treatment effect as shown in the following 2-way ANOVAs. For example, the Mean for Positive Mood is significantly different between the non-verbal physician empathy (empathetic, non-empathetic) and patient gender (male, female) factors. In addition, the Mean for Negative Mood is significantly different for the empathy factor. Hence, we feel that ANCOVA was not appropriate for the paper’s experiment.

```{r}
# check predictor and covariate independence
covariate_independence1 <- lm(positive_mood ~ factored_condemp + factored_sex, project_data_tidied)
anova(covariate_independence1)
covariate_independence2 <- lm(negative_mood ~ factored_condemp + factored_sex, project_data_tidied)
anova(covariate_independence2)
```

As a takeaway from this project, the above analysis demonstrates that before performing an experiment using ANCOVAs, it is extremely important to test the assumptions underlying those ANCOVAs. For example, it is important to test and see if the covariates of an ANCOVA are independent of the predictor variables or not. If not, then the ANCOVA test should not be attempted on that dataset. For our paper, the authors concluded that medical education should include non-verbal empathy training. However, given the possibility of incorrect usage of ANCOVA by the authors, we have to wonder whether the authors’ conclusion is valid anymore.